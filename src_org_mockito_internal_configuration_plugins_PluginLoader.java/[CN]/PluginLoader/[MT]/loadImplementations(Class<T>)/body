{
  ClassLoader loader=Thread.currentThread().getContextClassLoader();
  if (loader == null) {
    loader=ClassLoader.getSystemClassLoader();
  }
  Enumeration<URL> resources;
  try {
    resources=loader.getResources("mockito-extensions/" + service.getName());
  }
 catch (  IOException e) {
    throw new MockitoException("Failed to load " + service,e);
  }
  List<T> result=new ArrayList<T>();
  try {
    String foundPluginClass=new PluginFinder(pluginSwitch).findPluginClass(Iterables.toIterable(resources));
    if (foundPluginClass != null) {
      Class<?> pluginClass=loader.loadClass(foundPluginClass);
      Object plugin=pluginClass.newInstance();
      result.add(service.cast(plugin));
    }
    return result;
  }
 catch (  Exception e) {
    throw new MockitoConfigurationException("Failed to load " + service + " implementation declared in "+ resources,e);
  }
}
