{
  validateClass(toMock);
  Enhancer enhancer=createEnhancer(toMock);
  enhancer.setCallbackType(filter.getClass());
  Class mockClass=enhancer.createClass();
  Factory mock=createMock(mockClass);
  mock.setCallbacks(new Callback[]{filter});
  filter.setInstance(optionalInstance != null ? optionalInstance : mock);
  return (T)mock;
}
